---
title: "FinalProject.Rmd"
author: "Group 9"
date: "12/1/2017"
resource_files:
- .Renviron
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
runtime: shiny
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
require(data.world)
require(MASS)
require(ISLR)
require(dplyr)
require(ggplot2)
```
## Data Model

![Our original data model was rather messy, as we had ~20 tables as well as the US Census Data.](/Users/amandale/Desktop/Screen Shot 2017-11-28 at 5.47.20 PM.png)

![After an extensive process of cleaning data, this is the resulting data model.](/Users/amandale/Desktop/Screen Shot 2017-11-29 at 12.12.44 AM.png)



## Data Cleaning 
We initially had 20 tables to clean - so for simplicity's sake we will just show an example of how we cleaned a few of these twenty. 

```{r, eval = FALSE}
daycare	=	read_csv("/Users/amandale/Downloads/stcyngyn-fall-2017-edvproject-5/day_care_centers.csv", col_types = cols(
  place_id = col_character(),
  zipcode = col_integer(),
  place_type = col_character(),
  place_name = col_character(),
  latitude = col_double(),
  longitude = col_double(),
  website_url = col_character(),
  property_address = col_character(),
  map_url = col_character(),
  phone = col_character(),
  opening_hours = col_character()
))

daycare = daycare %>% dplyr::select(place_id, zipcode, place_type, place_name, latitude, longitude, opening_hours)

for(n in names(daycare)){
  daycare[n] <- data.frame(lapply(daycare[n], gsub, pattern="[^ -~]",replacement = ""))
}

write_csv(daycare, "/Users/amandale/Downloads/DataCleaning/daycarecenters.csv")

```

We also have a slew of tables that should be combined into one. This also involved changing the column names as well as creating a new column. The code we used to do this is below: 
```{r, eval=FALSE}
driver_serv = dplyr::mutate(driver_serv, place = "driver service")
esl = dplyr::mutate(esl, place = "esl")
grocery = dplyr::mutate(grocery, place = "grocery store")
markets = dplyr::mutate(markets, place = "market")

names(markets)[3] = "place_type"
names(markets)[4] = "place_name"

pcp = dplyr::mutate(pcp, place = "primary care location")
supermarkets = dplyr::mutate(supermarkets, place = "supermarket")
worship = dplyr::mutate(worship, place = "place of worship")
places = rbind(driver_serv, esl)
places = rbind(places, grocery)
places = rbind(places, markets)
places = rbind(places, pcp)
places = rbind(places, supermarkets)
places = rbind(places, worship)
```

```{r}
project <- "https://data.world/rc38246/f-17-edv-project-5"
data.world::set_config(cfg_env("DW_API"))
schools <- data.world::query(
  data.world::qry_sql("SELECT s.latitude AS slat, s.longitude AS slong, school_name, a.latitude AS alat, a.longitude AS along, apartment_name FROM schools AS s cross join apartments AS a WHERE s.grades = 'Elementary' and school_type = 'public'"),
  dataset = project
  )

zcta <- data.world::query(
  data.world::qry_sql("SELECT usa_zcta.zcta , usa_zcta.b25001_001 as housing_units , usa_zcta.b25058_001 as median_rent, usa_zcta.b25071_001 as rent_percentage_of_income
FROM usa_zcta"),
  dataset = project
)

zipcodes = c(30004,30005, 30009, 30012, 30013, 30017, 30021, 30023, 30024, 30028, 30030,30031,
             30032, 30033, 30034, 30035, 30038, 30039, 30040, 30043, 30047, 30052, 30058,
             30062, 30066, 30072, 30074, 30075, 30076, 30077, 30078, 30079)
zcta = zcta %>% dplyr::filter(is.element(zcta, zipcodes))

apartments <- data.world::query(
  data.world::qry_sql("SELECT apartments.apartment_name, apartments.latitude, apartments.longitude, apartments.place_id, apartments.zipcode
FROM apartments"),
  dataset = project
)

daycare <- data.world::query(
  data.world::qry_sql("SELECT daycarecenters.place_id, daycarecenters.zipcode, daycarecenters.place_type, daycarecenters.place_name,
daycarecenters.latitude, daycarecenters.longitude, daycarecenters.location, daycarecenters.opening_hours
FROM daycarecenters"),
  dataset = project
)

times <- data.world::query(
  data.world::qry_sql("SELECT zipcode, white_homeowners, market_time as mtime, school_time as stime FROM apartments JOIN times using(place_id) JOIN (SELECT usa_zcta.zcta,
usa_zcta.b25003a_001/usa_zcta.b25003_001 as white_homeowners
FROM usa_zcta) as temp on temp.zcta = apartments.zipcode"),
  dataset = project
  )
times <- times %>% dplyr::filter(is.element(zipcode, zipcodes)) %>% dplyr::mutate(market_time = dplyr::if_else(grepl("hour",mtime), 60*as.numeric(unlist(strsplit(mtime," "))[1])+as.numeric(unlist(strsplit(mtime," "))[3]),as.numeric(unlist(strsplit(mtime," "))[1])), school_time = dplyr::if_else(grepl("hour",stime), 60*as.numeric(unlist(strsplit(stime," "))[1])+as.numeric(unlist(strsplit(stime," "))[3]),as.numeric(unlist(strsplit(stime," "))[1]))) %>% dplyr::select(-mtime,-stime,-zipcode)

units <- data.world::query(
  data.world::qry_sql("SELECT * from units"),
  dataset = project
)

attach(schools)
attach(times)
```

## How many apartments are near how many public elementary schools?
Adjusting the slider below changes the range. If we set the slider to it's minimum value, we see that all apartments in the data set are within 1 km from a public elementary school. This means that the local municipalities did a good job of ensuring public education for their constituents.

Increasing the range causes the data to take a Boltzmann-like distribution, which means that the majority of apartments are near only a handful of schools, and the number of outliers decrease as you progress rightward on the graph. 

```{r echo=FALSE}
R = 6371
deg2rad <- function(deg) {(deg * pi) / (180)}
# Determines the curvilinear distance between two coordinates in km
distances <- schools %>% dplyr::mutate(dLat = deg2rad(slat-alat), dLon = deg2rad(slong-along), a = sin(dLat/2)*sin(dLat/2)+cos(deg2rad(slat))*cos(deg2rad(alat))*sin(dLon/2)*sin(dLon/2), c = 2*atan2(sqrt(a), sqrt(1-a)), dist = R*c) %>% dplyr::select(school_name,apartment_name,dist)

# How many schools are within 5 km of each apartment
# grouped <- distances %>% dplyr::filter(dist <= 1) %>% dplyr::group_by(apartment_name) %>% dplyr::summarise(num_schools = n())

# how many apartments are within 5 km of how many schools
# regrouped <- grouped %>% dplyr::group_by(num_schools) %>% summarise(num_apartments = n())
sliderInput("range", "Range (in km):", min = 1, max = 10, value = 5)

renderPlot({
  distances %>% dplyr::filter(dist <= input$range) %>% dplyr::group_by(apartment_name) %>% dplyr::summarise(num_schools = n()) %>% ggplot(aes(num_schools)) + geom_bar() + labs(x = "Number of Schools", y = "Number of Apartments")
})
```

##Ideal Refugee Location, pt. 2

```{r}
ggplot(data = zcta, mapping = aes(x=zcta, y=median_rent)) + geom_boxplot() + ggtitle("Rent Dist. by Zip")

ggplot(data = zcta, mapping = aes(x=zcta, y=rent_percentage_of_income)) + geom_boxplot() + ggtitle("Rent % by Zip")

ggplot(data = zcta, mapping = aes(x=zcta, y=median_rent)) + geom_boxplot() + ggtitle("Rent Dist. by Zip")

zcta2 = zcta %>% dplyr::mutate(accessible_housing = housing_units/median_rent)
ggplot(data = zcta2, mapping = aes(x=zcta, y=accessible_housing)) + geom_boxplot() + ggtitle("Accessible Housing by Zip")
```

##Housing, pt. 1

```{r}
ggplot(data = zcta, mapping = aes(x=zcta, y=housing_units)) + geom_bar(stat="identity") + ggtitle("Housing Units Available by Zip")

ggplot(data = zcta, mapping = aes(x=rent_percentage_of_income, y=median_rent)) + geom_point() + geom_smooth(method = lm, fullrange= TRUE, se=FALSE, color = "black" ) + ggtitle("Rent Analytics ") 

zcta3 = zcta %>% dplyr::mutate(housing_plentiful = ifelse(housing_units < 5000, "false", "true"))

ggplot(data = zcta3, mapping = aes(x=rent_percentage_of_income, y=median_rent, color = housing_plentiful)) + geom_point() + geom_smooth(method = lm, fullrange= TRUE, se=FALSE ) + ggtitle("Rent Analytics 2")
```


## dplyr Stuff

The chart below tracks the time it takes to get from an apartment to the nearest market and school graphed against the percentage of the population that is white. Since Atlanta is in the South, historical racial segregation would lead to the assumption that conditions would worsen as communities become less white. This would theoretically manifest itself as longer travel times to get to school and the market. The chart below, however, tells a very different story.
```{r echo = FALSE}
renderPlot({
  times %>% dplyr::filter(market_time<150,school_time<150)%>% tidyr::gather(variable, value, -white_homeowners) %>% ggplot(aes(x = white_homeowners, y = value, color = dplyr::if_else(variable == "market_time", "Home to Market", "Home to School"))) + geom_point() + labs(x = "Proportion of White Homeowners", y = "Travel Times (min)")
})
```
It would appear that the proportion of homeowners who are white has no effect on the travel time to schools nor the travel time to markets. Furthermore, the travel time to school seems uniform across the board. While the data alone gives no indication for cause, it is possible that this uniform travel time to school is the result of the Supreme Court's decision in Brown v. Board of Education, which forced the integration of de jure segregated schools in the South.

It also appears that the travel time to markets is polarized amongst two different extremes. In one case, the travel time is in the single digits; in the other, it's well over an hour. Unfortunately, the data alone is not sufficient to determine the cause.