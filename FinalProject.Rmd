---
title: "FinalProject.Rmd"
author: "Group 9"
date: "12/1/2017"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
runtime: shiny
resource_files:
- .Renviron
- Model1.png
- Model2.png
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
require(data.world)
require(MASS)
require(ISLR)
require(dplyr)
require(ggplot2)
```
#<a name="model"></a>**Data Model**

![Our original data model was rather messy, as we had ~20 tables as well as the US Census Data.](./Model1.png)

![After an extensive process of cleaning data, this is the resulting data model.](./Model2.png)



#<a name="clean"></a>**Data Cleaning** 
We initially had 20 tables to clean - so for simplicity's sake we will just show an example of how we cleaned a few of these twenty. 

```{r, eval = FALSE}
daycare	=	read_csv("/Users/amandale/Downloads/stcyngyn-fall-2017-edvproject-5/day_care_centers.csv", col_types = cols(
  place_id = col_character(),
  zipcode = col_integer(),
  place_type = col_character(),
  place_name = col_character(),
  latitude = col_double(),
  longitude = col_double(),
  website_url = col_character(),
  property_address = col_character(),
  map_url = col_character(),
  phone = col_character(),
  opening_hours = col_character()
))

daycare = daycare %>% dplyr::select(place_id, zipcode, place_type, place_name, latitude, longitude, opening_hours)

for(n in names(daycare)){
  daycare[n] <- data.frame(lapply(daycare[n], gsub, pattern="[^ -~]",replacement = ""))
}

write_csv(daycare, "/Users/amandale/Downloads/DataCleaning/daycarecenters.csv")

```

We also have a slew of tables that should be combined into one. This also involved changing the column names as well as creating a new column. The code we used to do this is below: 
```{r, eval=FALSE}
driver_serv = dplyr::mutate(driver_serv, place = "driver service")
esl = dplyr::mutate(esl, place = "esl")
grocery = dplyr::mutate(grocery, place = "grocery store")
markets = dplyr::mutate(markets, place = "market")

names(markets)[3] = "place_type"
names(markets)[4] = "place_name"

pcp = dplyr::mutate(pcp, place = "primary care location")
supermarkets = dplyr::mutate(supermarkets, place = "supermarket")
worship = dplyr::mutate(worship, place = "place of worship")
places = rbind(driver_serv, esl)
places = rbind(places, grocery)
places = rbind(places, markets)
places = rbind(places, pcp)
places = rbind(places, supermarkets)
places = rbind(places, worship)
```


#<a name="sql"></a>**SQL Queries**

Import the data from data.world, where the bulk of the work is done on the back end.

```{r}
project <- "https://data.world/rc38246/f-17-edv-project-5"
data.world::set_config(cfg_env("DW_API"))
schools <- data.world::query(
  data.world::qry_sql("SELECT s.latitude AS slat, s.longitude AS slong, school_name, a.latitude AS alat, a.longitude AS along, apartment_name FROM schools AS s cross join apartments AS a WHERE s.grades = 'Elementary' and school_type = 'public'"),
  dataset = project
  )
places <- data.world::query(
  data.world::qry_sql("SELECT place_name, place, market_time, school_time FROM places JOIN times using(place_id)"),
  dataset = project
  )
zcta <- data.world::query(
  data.world::qry_sql("SELECT usa_zcta.zcta , usa_zcta.b25001_001 as housing_units , usa_zcta.b25058_001 as median_rent, usa_zcta.b25071_001 as rent_percentage_of_income
FROM usa_zcta"),
  dataset = project
)

zipcodes = c(30004,30005, 30009, 30012, 30013, 30017, 30021, 30023, 30024, 30028, 30030,30031,
             30032, 30033, 30034, 30035, 30038, 30039, 30040, 30043, 30047, 30052, 30058,
             30062, 30066, 30072, 30074, 30075, 30076, 30077, 30078, 30079)
zcta = zcta %>% dplyr::filter(is.element(zcta, zipcodes))

apartments <- data.world::query(
  data.world::qry_sql("SELECT apartments.apartment_name, apartments.latitude, apartments.longitude, apartments.place_id, apartments.zipcode
FROM apartments"),
  dataset = project
)

daycare <- data.world::query(
  data.world::qry_sql("SELECT daycarecenters.place_id, daycarecenters.zipcode, daycarecenters.place_type, daycarecenters.place_name,
daycarecenters.latitude, daycarecenters.longitude, daycarecenters.location, daycarecenters.opening_hours
FROM daycarecenters"),
  dataset = project
)

units <- data.world::query(
  data.world::qry_sql("SELECT * from units"),
  dataset = project
)

attach(schools)
attach(places)
```

#<a name="tableau"></a>**Initial Exploratory Analysis**

#<a name="apts"></a>**How many apartments are near how many public elementary schools?**
Adjusting the slider below changes the range. If we set the slider to it's minimum value, we see that all apartments in the data set are within 1 km from a public elementary school. This means that the local municipalities did a good job of ensuring public education for their constituents.

Increasing the range causes the data to take a Boltzmann-like distribution, which means that the majority of apartments are near only a handful of schools, and the number of outliers decrease as you progress rightward on the graph. 

```{r echo=FALSE}
R = 6371
deg2rad <- function(deg) {(deg * pi) / (180)}
# Determines the curvilinear distance between two coordinates in km
distances <- schools %>% dplyr::mutate(dLat = deg2rad(slat-alat), dLon = deg2rad(slong-along), a = sin(dLat/2)*sin(dLat/2)+cos(deg2rad(slat))*cos(deg2rad(alat))*sin(dLon/2)*sin(dLon/2), c = 2*atan2(sqrt(a), sqrt(1-a)), dist = R*c) %>% dplyr::select(school_name,apartment_name,dist)

# How many schools are within 5 km of each apartment
# grouped <- distances %>% dplyr::filter(dist <= 1) %>% dplyr::group_by(apartment_name) %>% dplyr::summarise(num_schools = n())

# how many apartments are within 5 km of how many schools
# regrouped <- grouped %>% dplyr::group_by(num_schools) %>% summarise(num_apartments = n())
sliderInput("range", "Range (in km):", min = 1, max = 10, value = 5)

renderPlot({
  distances %>% dplyr::filter(dist <= input$range) %>% dplyr::group_by(apartment_name) %>% dplyr::summarise(num_schools = n()) %>% ggplot(aes(num_schools)) + geom_bar() + labs(x = "Number of Schools", y = "Number of Apartments")
})
# grouped <- data %>% dplyr::group_by(agent_key) %>% summarise(sum_with_offer = sum(calls_with_offer), sum_with_accept = sum(calls_with_accept), sum_offer_applied = sum(calls_offer_applied)) 
# 
# gathered <- grouped %>% tidyr::gather(variable,value, -agent_key)
# 
# renderPlot({
#   gathered %>% ggplot(aes(x = agent_key, y = value, color = variable)) + geom_smooth(se = FALSE)
# })
# 
# attach(grouped)
```

#<a name="units"></a>**Units**

#<a name="race"></a>**Race Data (Title WIP)**

#<a name="rfg"></a>**Ideal Refugee Location, pt. 2**
```{r}
ggplot(data = zcta, mapping = aes(x=zcta, y=median_rent)) + geom_boxplot() + ggtitle("Rent Dist. by Zip")

ggplot(data = zcta, mapping = aes(x=zcta, y=rent_percentage_of_income)) + geom_boxplot() + ggtitle("Rent % by Zip")

ggplot(data = zcta, mapping = aes(x=zcta, y=median_rent)) + geom_boxplot() + ggtitle("Rent Dist. by Zip")

zcta2 = zcta %>% dplyr::mutate(accessible_housing = housing_units/median_rent)
ggplot(data = zcta2, mapping = aes(x=zcta, y=accessible_housing)) + geom_boxplot() + ggtitle("Accessible Housing by Zip")
```

#<a name="housing"></a>**Housing, pt. 1**
```{r}
ggplot(data = zcta, mapping = aes(x=zcta, y=housing_units)) + geom_bar(stat="identity") + ggtitle("Housing Units Available by Zip")

ggplot(data = zcta, mapping = aes(x=rent_percentage_of_income, y=median_rent)) + geom_point() + geom_smooth(method = lm, fullrange= TRUE, se=FALSE, color = "black" ) + ggtitle("Rent Analytics ") 

zcta3 = zcta %>% dplyr::mutate(housing_plentiful = ifelse(housing_units < 5000, "false", "true"))

ggplot(data = zcta3, mapping = aes(x=rent_percentage_of_income, y=median_rent, color = housing_plentiful)) + geom_point() + geom_smooth(method = lm, fullrange= TRUE, se=FALSE ) + ggtitle("Rent Analytics 2")
```


#<a name="dplyr"></a>**dplyr stuff**

Looking into most successful agents and teams
topics coverered - piplines. select, mutate , group_by, summarize, arrange
```{r echo = FALSE}
# data_SA = data %>% dplyr::select(agent_key, agent_name, calls_with_accept, calls, team_lead_id) %>% dplyr::mutate(call_acceptance_rate = calls_with_accept / calls) %>% dplyr::group_by(agent_key, agent_name,team_lead_id) %>% dplyr::summarize(avg_calls_with_a = mean(calls_with_accept), avg_calls = mean(calls), avg_call_acceptance_rate = mean(call_acceptance_rate))
# 
# data_SA_sort = data_SA %>% dplyr::arrange(desc(avg_call_acceptance_rate))
# 
# data_SA_sort = data_SA %>% dplyr::arrange(avg_call_acceptance_rate)
# 
# teams = data_SA %>% dplyr::select(team_lead_id, avg_calls, avg_call_acceptance_rate) %>% dplyr::group_by(team_lead_id) %>% dplyr::summarize(mean(avg_calls), mean(avg_call_acceptance_rate))
# 
# renderPlot({
#   ggplot(data = teams, aes(x=`mean(avg_calls)`, y = `mean(avg_call_acceptance_rate)`)) + geom_line()
# })

```

#**Appendix**  
***Tableau Concepts***  
boxplot [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FiQQPondtTkKFjE2WWTRh_image.png&id=e362784c-4162-4d00-a1e1-f9111dc0d35d&source=sb)   
histogram [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FyylcBAOsQYqHIum7NIjs_image.png&id=46205490-5cd9-4785-80a3-2484fbbe910f&source=sb) [2](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FdpOkzLT9qREjEJ41Lcvw_Worship1.png&id=47640be2-b17b-4ebd-9a75-d968fec84196&source=sb) [3](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FcLfg5bC4QoiKozJxJD4Q_school1.png&id=0d7038d0-0916-44ef-828d-4e42e00b6982&source=sb) [4](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FofCFxvrTQOKZftCJypZQ_image.png&id=d28e82a5-c90b-4aa8-8b7b-846e762978ea&source=sb)  
packed bubbles [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2F9BkDqC9FT7qoGyBHpMnu_Daycare%2520Center.png&id=e07d5374-fbd9-43b0-8b49-6a797be72f1f&source=sb)  
treemap [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2F4Q7Pc8YT4yTuUy3wIRrB_image.png&id=33a98ef9-a3ed-4d7b-822f-97d66aa82bef&source=sb)  
scatterplot [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FUETCkNnRcedvmbVpaYD4_medianvhousing.png&id=c4a739e8-2601-4dc6-9936-b8781f901e62&source=sb) [2](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FyX179ukTSdCaVTDkHP47_image.png&id=8cb47d40-ba0c-4fa1-b57b-9db57145f93f&source=sb)  
maps/actions [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FioiPLtxGTCKEtL6DaOjS_image.png&id=014552b8-a4ad-4be2-ab3e-84fca506b7b5&source=sb)  
dashboard [1](https://data.world/rc38246/f-17-edv-project-5/insights/46205490-5cd9-4785-80a3-2484fbbe910f)  
trend model [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2Fbvr8mJoTmCMsCyqzHJ2t_image.png&id=8cb47d40-ba0c-4fa1-b57b-9db57145f93f&source=sb)  
barchart [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FM2CZgoiSRVCMhE3SkKJv_image.png&id=ab42f491-a0a3-4170-b210-4bad400fad06&source=sb) [2](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FyX179ukTSdCaVTDkHP47_image.png&id=8cb47d40-ba0c-4fa1-b57b-9db57145f93f&source=sb)  
ID set [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FM2CZgoiSRVCMhE3SkKJv_image.png&id=ab42f491-a0a3-4170-b210-4bad400fad06&source=sb)  
crosstab [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FRgsajxEUSo6W4Fbszz0H_crosstab2.png&id=6379e9bc-e0c8-45d2-ba5c-6351b1424f1f&source=sb)   
calculated fields [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FyX179ukTSdCaVTDkHP47_image.png&id=8cb47d40-ba0c-4fa1-b57b-9db57145f93f&source=sb) [2](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FiQQPondtTkKFjE2WWTRh_image.png&id=e362784c-4162-4d00-a1e1-f9111dc0d35d&source=sb)  
set [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FiQQPondtTkKFjE2WWTRh_image.png&id=e362784c-4162-4d00-a1e1-f9111dc0d35d&source=sb) [2](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FyLLFqp4RQGq5XUjes1Op_image.png&id=df0e03e7-38da-4bf1-9deb-ed10e35771d9&source=sb)
parameter [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FyX179ukTSdCaVTDkHP47_image.png&id=8cb47d40-ba0c-4fa1-b57b-9db57145f93f&source=sb)   
dual axis [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FTpS2000vRCSU6Fr9tfaT_image.png&id=a9dc7bba-08a5-47fc-a3c1-1a5c4f3e5a85&source=sb)  
pages [1](https://data.world/rc38246/f-17-edv-project-5/insights?anchor=https%3A%2F%2Fmedia.data.world%2FyLLFqp4RQGq5XUjes1Op_image.png&id=df0e03e7-38da-4bf1-9deb-ed10e35771d9&source=sb) [2](https://data.world/rc38246/f-17-edv-project-5/insights/0d7038d0-0916-44ef-828d-4e42e00b6982)  

***ggplot Concepts***  
boxplot [1](#rfg)  
histogram  
packed bubbles  
treemap  
scatterplot  
maps/actions  
dashboard  
trend model  
barchart  
ID set  
crosstab   
calculated fields  
set  
parameter  
dual axis  
pages  

***SQL***  
select [1](#sql)  
where [1](#sql)  
group by  
joins [1](#sql)  

***dplyr methods***  
select [1](#clean) [2](#apts)  
mutate [1](#clean) [2](#apts) [3](#rfg) [4](#housing)  
filter [1](#sql) [2](#apts)  
group by [1](#apts)  
summarise [1](#apts)  

***other***  
data model [1](#model)  
read_csv [1](#clean)    
write_csv [1](#clean)    
regular expressions [1](#clean)  
tidyr::gather  