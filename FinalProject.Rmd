---
title: "FinalProject.Rmd"
author: "Group 9"
date: "12/1/2017"
resource_files:
- .Renviron
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
runtime: shiny
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
require(data.world)
require(MASS)
require(ISLR)
require(dplyr)
require(ggplot2)
```

## Non SELECT * SQL

Import the data from data.world, where the bulk of the work is done on the back end.

```{r}
project <- "https://data.world/rc38246/f-17-edv-project-5"
data.world::set_config(cfg_env("DW_API"))
schools <- data.world::query(
  data.world::qry_sql("SELECT s.latitude AS slat, s.longitude AS slong, school_name, a.latitude AS alat, a.longitude AS along, apartment_name FROM schools AS s cross join apartments AS a WHERE s.grades = 'Elementary' and school_type = 'public'"),
  dataset = project
  )
times <- data.world::query(
  data.world::qry_sql("SELECT apartment_name, market_time, school_time FROM apartments JOIN times using(place_id)"),
  dataset = project
  )
attach(schools)
attach(times)
```

## How many apartments are near how many public elementary schools?
Adjusting the slider below changes the range. If we set the slider to it's minimum value, we see that all apartments in the data set are within 1 km from a public elementary school. This means that the local municipalities did a good job of ensuring public education for their constituents.

Increasing the range causes the data to take a Boltzmann-like distribution, which means that the majority of apartments are near only a handful of schools, and the number of outliers decrease as you progress rightward on the graph. 

```{r echo=FALSE}
R = 6371
deg2rad <- function(deg) {(deg * pi) / (180)}
# Determines the curvilinear distance between two coordinates in km
distances <- schools %>% dplyr::mutate(dLat = deg2rad(slat-alat), dLon = deg2rad(slong-along), a = sin(dLat/2)*sin(dLat/2)+cos(deg2rad(slat))*cos(deg2rad(alat))*sin(dLon/2)*sin(dLon/2), c = 2*atan2(sqrt(a), sqrt(1-a)), dist = R*c) %>% dplyr::select(school_name,apartment_name,dist)

# How many schools are within 5 km of each apartment
# grouped <- distances %>% dplyr::filter(dist <= 1) %>% dplyr::group_by(apartment_name) %>% dplyr::summarise(num_schools = n())

# how many apartments are within 5 km of how many schools
# regrouped <- grouped %>% dplyr::group_by(num_schools) %>% summarise(num_apartments = n())
sliderInput("range", "Range (in km):", min = 1, max = 10, value = 5)

renderPlot({
  distances %>% dplyr::filter(dist <= input$range) %>% dplyr::group_by(apartment_name) %>% dplyr::summarise(num_schools = n()) %>% ggplot(aes(num_schools)) + geom_bar() + labs(x = "Number of Schools", y = "Number of Apartments")
})
```

## dplyr Stuff

Looking into most successful agents and teams
topics coverered - piplines. select, mutate , group_by, summarize, arrange
```{r echo = FALSE}
renderPlot({
  times %>% tidyr::gather(variable, value, -apartment_name) %>% ggplot(aes(x = apartment_name, y = value, color = variable)) + geom_point()
})


```